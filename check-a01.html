<! — copy the following HTML/JS into your file —>
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>API Viewer (ปรับปรุง)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        * { box-sizing: border-box; }
        body { background: #f0f2f5; margin:0; font-family:'Inter',sans-serif; display:flex; justify-content:center; padding:30px 15px; min-height:100vh; }
        .container { background:white; padding:30px 40px; border-radius:12px; max-width:800px; width:100%; box-shadow:0 12px 24px rgba(0,0,0,0.12); display:flex; flex-direction:column; gap:20px; }
        h1 { margin:0; font-weight:600; font-size:1.6rem; text-align:center; }
        label { font-weight:600; margin-bottom:6px; color:#444; display:block; }
        input[type="text"], input[type="url"] { width:100%; padding:10px 14px; border-radius:8px; border:1.8px solid #ccc; font-size:1rem; margin:10px 0; }
        .btn-group { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
        button { padding:12px 18px; font-size:1rem; font-weight:600; border:none; border-radius:10px; cursor:pointer; min-width:120px; }
        #btnFetch { background:#4f46e5; color:white; box-shadow:0 6px 12px rgba(79,70,229,0.28); }
        #btnClear { background:#e02424; color:white; }
        #result { background:#1e1e2f; color:#d4d4fc; font-family:monospace; border-radius:12px; padding:16px; min-height:220px; overflow:auto; white-space:pre-wrap; }
        .error { color:#e02424; background:#ffecec; padding:10px; border-radius:8px; border:1px solid #e02424; display:none; }
        .hint { font-size:0.9rem; color:#666; }
        .spinner { display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation:spin 1s linear infinite; vertical-align:middle; margin-left:8px; }
        @keyframes spin { to { transform:rotate(360deg); } }
        @media (max-width:480px) { .container { padding:16px; } }
    </style>
</head>
<body>
    <div class="container" role="main">
        <h1>API Viewer (ปรับปรุง)</h1>

        <form id="apiForm" autocomplete="off" aria-label="Form for inputting API URL with credentials">
            <label for="fullUrl">API URL ที่มี username &amp; password (หรือใส่แบบมีเฉพาะ host แล้วเพิ่มในฟอร์ม):</label>
            <input type="url" id="fullUrl" name="fullUrl" placeholder="http://xxxx.xxx:8080/player_api.php?username=xxx&password=yyy" required aria-required="true" />
            <div class="hint">คำเตือน: การใส่ username/password ใน URL เสี่ยงต่อการถูกบันทึกใน history/logs — ควรใช้วิธีที่ปลอดภัยกว่าใน production</div>

            <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
                <div class="btn-group" style="margin:0;">
                    <button type="submit" id="btnFetch">Get Info</button>
                    <button type="button" id="btnClear">Clear</button>
                </div>
                <div id="loadingArea" aria-hidden="true" style="min-width:120px; display:flex; align-items:center; justify-content:flex-end;">
                    <!-- loading indicator -->
                </div>
            </div>
        </form>

        <div class="error" id="error" role="alert" aria-live="polite"></div>

        <pre id="result" aria-live="polite" aria-label="API response output"></pre>
    </div>

    <script>
        // Utility: convert Unix timestamp (seconds) to readable
        function convertTimestamp(ts) {
            const t = Number(ts);
            if (!Number.isFinite(t)) return ts;
            try {
                const d = new Date(t * 1000);
                if (isNaN(d)) return ts;
                return d.toISOString().replace('T', ' ').substr(0, 19);
            } catch (e) {
                return ts;
            }
        }

        const form = document.getElementById('apiForm');
        const resultElem = document.getElementById('result');
        const errorElem = document.getElementById('error');
        const btnClear = document.getElementById('btnClear');
        const inputUrl = document.getElementById('fullUrl');
        const btnFetch = document.getElementById('btnFetch');
        const loadingArea = document.getElementById('loadingArea');

        // เริ่มต้น: ถ้ามี ?url= ใน query string ให้ prefill
        function getQueryParam(param) {
            const params = new URLSearchParams(window.location.search);
            return params.get(param);
        }
        const prefillUrl = getQueryParam('url');
        if (prefillUrl) inputUrl.value = decodeURIComponent(prefillUrl);

        // ฟังก์ชันแก้ path "get.php" เป็น "player_api.php" (robust)
        function fixApiPath(urlObj) {
            // เปลี่ยนเฉพาะเมื่อ pathname ลงท้ายด้วย get.php
            urlObj.pathname = urlObj.pathname.replace(/\/?get\.php$/i, '/player_api.php');
            return urlObj;
        }

        // Mask sensitive fields in JSON object before showing
        function maskSensitive(obj) {
            if (!obj || typeof obj !== 'object') return obj;
            const clone = JSON.parse(JSON.stringify(obj)); // deep copy (simple)
            function walk(o){
                if (!o || typeof o !== 'object') return;
                for (const k of Object.keys(o)){
                    try {
                        const v = o[k];
                        if (k.toLowerCase().includes('password')) {
                            o[k] = '*****';
                        } else if (k.toLowerCase().includes('username') && typeof v === 'string') {
                            o[k] = v.length > 3 ? v.substr(0,1) + '***' + v.substr(-1) : '***';
                        } else if (typeof v === 'object') {
                            walk(v);
                        }
                    } catch(e){}
                }
            }
            walk(clone);
            return clone;
        }

        // Prepare UI state
        function setLoading(isLoading) {
            btnFetch.disabled = isLoading;
            btnClear.disabled = isLoading;
            if (isLoading) {
                loadingArea.innerHTML = '<span class="spinner" aria-hidden="true"></span><span style="margin-left:8px;color:#555;font-size:0.95rem;">Loading...</span>';
            } else {
                loadingArea.innerHTML = '';
            }
        }

        // Show/clear error
        function showError(msg) {
            errorElem.style.display = 'block';
            errorElem.textContent = msg;
        }
        function clearError() {
            errorElem.style.display = 'none';
            errorElem.textContent = '';
        }

        // Build proxy URL function (using public instance by default)
        const PROXY_ORIGIN = 'https://cors-anywhere.com'; // public example — for production self-host
        // Note: public proxy may have rate-limits and not suitable for production [(CORS Anywhere)](https://cors-anywhere.com/)
        function buildProxyFor(urlStr) {
            // CORS Anywhere expects the target URL path after the origin: /http://target/...
            // We ensure there's no accidental double slash after origin.
            const trimmedOrigin = PROXY_ORIGIN.replace(/\/+$/,'');
            return trimmedOrigin + '/' + urlStr;
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            clearError();
            resultElem.textContent = '';

            let raw = inputUrl.value.trim();
            if (!raw) {
                showError('กรุณากรอก URL');
                return;
            }

            // Add protocol if missing
            if (!/^[a-zA-Z][a-zA-Z0-9+\-.]*:\/\//.test(raw)) {
                // default to http (but HTTPS recommended)
                raw = 'http://' + raw;
            }

            let urlObj;
            try {
                urlObj = new URL(raw);
            } catch (e) {
                showError('URL ไม่ถูกต้อง');
                return;
            }

            // Fix path if needed
            urlObj = fixApiPath(urlObj);

            // Ensure username/password in query params
            const username = urlObj.searchParams.get('username');
            const password = urlObj.searchParams.get('password');
            if (!username || !password) {
                showError('กรุณาใส่ username และ password ใน URL (query string) หรือใช้วิธีส่ง credential ที่ปลอดภัยกว่า');
                return;
            }

            // Ensure action
            if (!urlObj.searchParams.get('action')) {
                urlObj.searchParams.set('action', 'get_info');
            }

            // Remove type/output params (as original)
            urlObj.searchParams.delete('type');
            urlObj.searchParams.delete('output');

            // Build proxy url
            const proxyUrl = buildProxyFor(urlObj.toString());

            // UX: set loading and use AbortController for timeout
            setLoading(true);
            resultElem.textContent = 'Loading...';
            const controller = new AbortController();
            const timeoutMs = 15000; // 15s
            const timeout = setTimeout(() => controller.abort(), timeoutMs);

            try {
                // Use header X-Requested-With as before (some CORS Anywhere instances expect)
                const resp = await fetch(proxyUrl, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    signal: controller.signal,
                });

                clearTimeout(timeout);

                if (!resp.ok) {
                    throw new Error(`Network response was not ok: ${resp.status} ${resp.statusText}`);
                }

                // Read text first and try parse JSON safely
                const text = await resp.text();
                let parsed = null;
                try {
                    parsed = text ? JSON.parse(text) : null;
                } catch (e) {
                    // Not JSON — show raw text but warn
                    resultElem.textContent = 'ไม่สามารถ parse JSON ได้ — raw response:\n\n' + text;
                    setLoading(false);
                    return;
                }

                // Convert known timestamps if present
                if (parsed && typeof parsed === 'object') {
                    if (parsed.user_info) {
                        if (parsed.user_info.exp_date) parsed.user_info.exp_date_readable = convertTimestamp(parsed.user_info.exp_date);
                        if (parsed.user_info.created_at) parsed.user_info.created_at_readable = convertTimestamp(parsed.user_info.created_at);
                    }
                    if (parsed.server_info && parsed.server_info.timestamp_now) {
                        parsed.server_info.timestamp_now_readable = convertTimestamp(parsed.server_info.timestamp_now);
                    }
                }

                // Mask credentials in displayed output (do not show raw username/password)
                const masked = maskSensitive(parsed);

                resultElem.textContent = JSON.stringify(masked, null, 4);

            } catch (err) {
                if (err.name === 'AbortError') {
                    showError('Request timed out (' + (timeoutMs/1000) + 's)');
                } else {
                    showError('เกิดข้อผิดพลาด: ' + err.message);
                }
                resultElem.textContent = '';
            } finally {
                clearTimeout(timeout);
                setLoading(false);
            }
        });

        btnClear.addEventListener('click', () => {
            inputUrl.value = '';
            clearError();
            resultElem.textContent = '';
            inputUrl.focus();
        });
    </script>
</body>
</html>
