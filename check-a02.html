<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>API Viewer — Improved UI/UX (wide)</title>
    <style>
        /* Core layout */
        :root{
            --bg:#eef2ff;
            --card:#ffffff;
            --accent:#4f46e5;
            --danger:#e02424;
            --muted:#6b7280;
            --mono:'Source Code Pro', monospace;
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: linear-gradient(180deg, var(--bg) 0%, #f7fafc 100%);
            display:flex;
            justify-content:center;
            align-items:flex-start;
            padding:36px;
            min-height:100vh;
        }
        .wrap{
            width:90%; /* changed to 90% of viewport width */
            max-width:none; /* allow 90% to take effect */
            background:var(--card);
            border-radius:14px;
            padding:28px;
            box-shadow: 0 18px 40px rgba(15,23,42,0.12);
            display:grid;
            grid-template-columns: 1fr 560px; /* wider output column */
            gap:22px;
            align-items:start;
        }
        h1{margin:0;font-size:1.45rem;color:#0f172a;font-weight:800}
        p.lead{margin:8px 0 16px;color:var(--muted);font-size:1rem;line-height:1.35}

        /* Left column (controls) */
        .panel{padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(79,70,229,0.03),transparent);}
        label{display:block;font-weight:700;margin-bottom:8px;color:#111827}
        input[type="text"], select{
            width:100%;
            padding:12px 14px;
            border-radius:10px;
            border:1.5px solid #e6e7ee;
            font-size:1rem;
        }
        input[type="text"]:focus, select:focus{outline:none;border-color:var(--accent);box-shadow:0 8px 28px rgba(79,70,229,0.08)}
        .row{display:flex;gap:10px}
        .small{font-size:0.95rem;color:var(--muted)}

        .controls{
            display:flex;
            gap:12px;
            margin-top:14px;
            flex-wrap:wrap;
        }
        button{
            border:none;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;font-size:0.95rem;
        }
        .btn-primary{background:var(--accent);color:white;box-shadow:0 10px 26px rgba(79,70,229,0.16)}
        .btn-ghost{background:transparent;border:1px solid #e6e7ee;color:#111827}
        .btn-danger{background:var(--danger);color:white}
        .btn-icon{display:inline-flex;align-items:center;gap:8px;padding:10px 12px}

        .meta{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
        .tag{background:#f8fafc;padding:8px 12px;border-radius:999px;font-size:0.9rem;color:#374151;border:1px solid #eef2ff}

        .presets, .history{margin-top:14px}
        .list {max-height:220px;overflow:auto;padding:10px;border-radius:10px;background:#fff;border:1px dashed #eef2ff}
        .list button{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;background:transparent;border:none;color:#0f172a;font-weight:600}
        .list button:hover{background:#f8fafc}

        /* Right column (output) */
        .output-wrap{display:flex;flex-direction:column;gap:12px}
        .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between}
        .toolbar-left{display:flex;gap:12px;align-items:center}
        .status{padding:8px 12px;border-radius:999px;background:#f3f4f6;color:#111827;font-weight:700;font-size:0.95rem}
        .result{
            background:#0f172a;color:#e6eef8;border-radius:12px;padding:18px;
            font-family:var(--mono);font-size:0.98rem;min-height:420px;overflow:auto;white-space:pre-wrap;line-height:1.45;
        }

        .error{
            color:var(--danger);
            background:#fff5f5;
            border:1px solid rgba(224,36,36,0.12);
            padding:12px;border-radius:10px;font-weight:700;
        }

        .note{font-size:0.95rem;color:var(--muted)}

        /* spinner */
        .spinner{
            width:22px;height:22px;border-radius:50%;border:3px solid rgba(255,255,255,0.18);border-top:3px solid white;
            animation:spin 1s linear infinite;display:inline-block;margin-left:8px;
        }
        @keyframes spin{to{transform:rotate(360deg)}}

        /* responsive */
        @media (max-width:1100px){
            .wrap{grid-template-columns:1fr; padding:18px}
            .result{min-height:320px}
            .panel{padding:12px}
        }

        @media (max-width:520px){
            .controls{gap:8px}
            button{padding:10px 12px;font-size:0.92rem}
            input[type="text"], select{padding:10px}
            .list{max-height:180px}
        }
    </style>
</head>
<body>
    <div class="wrap" role="main" aria-label="API Viewer improved UI">
        <div class="panel" aria-labelledby="title-controls">
            <h1 id="title-controls">API Viewer</h1>
            <p class="lead">ป้อน URL แบบมี username และ password (เช่น http://.../player_api.php?username=xxx&password=yyy). เพิ่มตัวอย่างและประวัติการเรียกเพื่อความสะดวก</p>

            <form id="apiForm" autocomplete="off" aria-label="Form for API URL with credentials">
                <label for="fullUrl">API URL (รวม username & password):</label>
                <input type="text" id="fullUrl" name="fullUrl" placeholder="http://xxxx.xxx:8080/player_api.php?username=xxx&password=xxx" required aria-required="true" />

                <div class="meta" aria-hidden="false">
                    <div class="tag" id="proxyTag">Using proxy: <strong style="margin-left:6px">cors-anywhere.herokuapp.com</strong></div>
                    <div class="tag" id="rateTag" title="Rate limit per website">Rate limit: 20 req/min</div>
                </div>

                <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
                    <label style="margin:0;font-weight:700">Action:</label>
                    <select id="actionSelect" aria-label="Choose API action">
                        <option value="">(use default: get_info)</option>
                        <option value="get_info">get_info</option>
                        <option value="get_simple_info">get_simple_info</option>
                        <option value="get_live_streams">get_live_streams</option>
                    </select>
                </div>

                <div class="controls" style="margin-top:12px;">
                    <button id="btnFetch" class="btn-primary" type="submit" aria-label="Get Info">Get Info</button>
                    <button id="btnClear" type="button" class="btn-ghost" aria-label="Clear form">Clear</button>
                    <button id="btnCopyUrl" type="button" class="btn-ghost btn-icon" aria-label="Copy request URL">Copy URL</button>
                    <button id="btnSavePreset" type="button" class="btn-ghost btn-icon" aria-label="Save to presets">Save Preset</button>
                    <button id="btnToggleProxy" type="button" class="btn-ghost btn-icon" aria-label="Toggle proxy usage">Toggle Proxy</button>
                </div>
            </form>

            <div class="presets">
                <label style="margin-bottom:6px">Presets / Examples:</label>
                <div class="list" id="presetList" role="listbox" aria-label="Example URLs">
                    <!-- populated dynamically -->
                </div>
            </div>

            <div class="history" style="margin-top:12px">
                <label style="margin-bottom:6px">History (local):</label>
                <div class="list" id="historyList" role="listbox" aria-label="History of used URLs">
                    <!-- history items -->
                </div>
            </div>

            <div style="margin-top:12px" class="note">
                หมายเหตุ: โค้ดยังคงใช้ CORS proxy ของ cors-anywhere.herokuapp.com สำหรับการเรียกข้ามต้นทาง (rate limit ของ instance นี้อาจมีการจำกัด).
            </div>
        </div>

        <div class="output-wrap" aria-live="polite">
            <div class="panel" style="padding:12px;">
                <div class="toolbar">
                    <div class="toolbar-left">
                        <div id="status" class="status">Ready</div>
                        <div id="httpStatus" style="margin-left:8px;color:var(--muted);font-weight:700"></div>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <button id="btnPretty" class="btn-ghost" title="Pretty / Raw view">Pretty</button>
                        <button id="btnCopy" class="btn-ghost" title="Copy response">Copy</button>
                        <button id="btnDownload" class="btn-ghost" title="Download JSON">Download</button>
                        <button id="btnToggleRaw" class="btn-ghost" title="Toggle raw/parsed">Raw</button>
                    </div>
                </div>

                <div id="error" class="error" role="alert" style="display:none;margin-top:10px"></div>

                <pre id="result" class="result" aria-label="API response output" tabindex="0"></pre>
            </div>

            <div style="display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:8px">
                <div class="note" id="lastInfo">--</div>
                <div>
                    <button id="btnClearHistory" class="btn-ghost" title="Clear history">Clear History</button>
                    <button id="btnResetPresets" class="btn-ghost" title="Reset presets">Reset Presets</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* --- Existing logic preserved + UI enhancements --- */

        // Helpers (unchanged logic preserved)
        function convertTimestamp(ts) {
            const t = parseInt(ts);
            if (isNaN(t)) return ts;
            const d = new Date(t * 1000);
            return d.toISOString().replace('T', ' ').substr(0, 19);
        }

        function fixApiPath(urlObj) {
            if(urlObj.pathname.endsWith("get.php")){
                urlObj.pathname = urlObj.pathname.replace("get.php", "player_api.php");
            }
            return urlObj;
        }

        // DOM
        const form = document.getElementById('apiForm');
        const resultElem = document.getElementById('result');
        const errorElem = document.getElementById('error');
        const btnClear = document.getElementById('btnClear');
        const inputUrl = document.getElementById('fullUrl');

        const btnFetch = document.getElementById('btnFetch');
        const btnCopy = document.getElementById('btnCopy');
        const btnCopyUrl = document.getElementById('btnCopyUrl');
        const btnDownload = document.getElementById('btnDownload');
        const btnPretty = document.getElementById('btnPretty');
        const btnToggleRaw = document.getElementById('btnToggleRaw');

        const presetList = document.getElementById('presetList');
        const historyList = document.getElementById('historyList');
        const lastInfo = document.getElementById('lastInfo');
        const statusEl = document.getElementById('status');
        const httpStatus = document.getElementById('httpStatus');
        const btnSavePreset = document.getElementById('btnSavePreset');
        const btnToggleProxy = document.getElementById('btnToggleProxy');
        const proxyTag = document.getElementById('proxyTag');
        const rateTag = document.getElementById('rateTag');
        const actionSelect = document.getElementById('actionSelect');
        const btnClearHistory = document.getElementById('btnClearHistory');
        const btnResetPresets = document.getElementById('btnResetPresets');

        // Presets (default examples) — you may customize
        const DEFAULT_PRESETS = [
            { name: 'Sample get_info', url: 'http://xxxx.xxx:8080/player_api.php?username=xxx&password=xxx&action=get_info' },
            { name: 'Simple info', url: 'http://xxxx.xxx:8080/player_api.php?username=xxx&password=xxx&action=get_simple_info' },
            { name: 'Live streams', url: 'http://xxxx.xxx:8080/player_api.php?username=xxx&password=xxx&action=get_live_streams' }
        ];

        // LocalStorage keys
        const LS_HISTORY = 'apiViewer_history_v1';
        const LS_PRESETS = 'apiViewer_presets_v1';
        const LS_LASTURL = 'apiViewer_lasturl_v1';
        const MAX_HISTORY = 12;

        // Proxy usage flag (UI only toggles whether to prepend proxy)
        let useProxy = true;
        const PROXY_BASE = 'https://cors-anywhere.herokuapp.com/';

        // Prefill from query param if present (keeps original behavior)
        function getQueryParam(param) {
            const params = new URLSearchParams(window.location.search);
            return params.get(param);
        }
        const prefillUrl = getQueryParam('url');
        if(prefillUrl) {
            inputUrl.value = decodeURIComponent(prefillUrl);
        } else {
            // restore last used URL
            const last = localStorage.getItem(LS_LASTURL);
            if(last) inputUrl.value = last;
        }

        // --- UI utilities ---
        function showError(msg) {
            errorElem.style.display = 'block';
            errorElem.textContent = msg;
            statusEl.textContent = 'Error';
            statusEl.style.background = '#fee2e2';
            statusEl.style.color = '#7f1d1d';
        }
        function clearError() {
            errorElem.style.display = 'none';
            errorElem.textContent = '';
            statusEl.textContent = 'Ready';
            statusEl.style.background = '';
            statusEl.style.color = '';
        }

        function setLoading(on) {
            if(on){
                statusEl.innerHTML = 'Loading <span class="spinner" aria-hidden="true"></span>';
            } else {
                statusEl.textContent = 'Ready';
            }
        }

        function updateLastInfo(text){
            lastInfo.textContent = text;
        }

        // History management
        function loadHistory(){
            try{
                const raw = localStorage.getItem(LS_HISTORY);
                return raw ? JSON.parse(raw) : [];
            }catch(e){return [];}
        }
        function saveHistoryItem(url){
            if(!url) return;
            let list = loadHistory();
            // remove dup
            list = list.filter(u => u.url !== url);
            list.unshift({ url, t: Date.now() });
            if(list.length > MAX_HISTORY) list = list.slice(0, MAX_HISTORY);
            localStorage.setItem(LS_HISTORY, JSON.stringify(list));
            localStorage.setItem(LS_LASTURL, url);
            renderHistory();
        }
        function clearHistory(){
            localStorage.removeItem(LS_HISTORY);
            renderHistory();
        }
        function renderHistory(){
            const list = loadHistory();
            historyList.innerHTML = '';
            if(list.length === 0){
                historyList.innerHTML = '<div style="padding:8px;color:var(--muted)">ไม่มีประวัติ</div>';
                return;
            }
            list.forEach(item => {
                const btn = document.createElement('button');
                const d = new Date(item.t);
                btn.innerHTML = `<strong>${item.url}</strong><div style="font-size:0.85rem;color:var(--muted)">${d.toLocaleString()}</div>`;
                btn.addEventListener('click', () => {
                    inputUrl.value = item.url;
                });
                historyList.appendChild(btn);
            });
        }

        // Presets management
        function loadPresets(){
            try{
                const raw = localStorage.getItem(LS_PRESETS);
                return raw ? JSON.parse(raw) : DEFAULT_PRESETS.slice();
            }catch(e){return DEFAULT_PRESETS.slice();}
        }
        function savePresets(arr){
            localStorage.setItem(LS_PRESETS, JSON.stringify(arr));
            renderPresets();
        }
        function addPreset(label, url){
            const arr = loadPresets();
            arr.unshift({ name: label || url, url });
            // keep a reasonable limit
            if(arr.length > 20) arr.pop();
            savePresets(arr);
        }
        function resetPresets(){
            localStorage.removeItem(LS_PRESETS);
            renderPresets();
        }
        function renderPresets(){
            const arr = loadPresets();
            presetList.innerHTML = '';
            if(arr.length === 0){
                presetList.innerHTML = '<div style="padding:8px;color:var(--muted)">No presets</div>';
                return;
            }
            arr.forEach(p => {
                const btn = document.createElement('button');
                btn.textContent = p.name;
                btn.title = p.url;
                btn.addEventListener('click', () => inputUrl.value = p.url);
                presetList.appendChild(btn);
            });
        }

        // Initialize lists
        renderPresets();
        renderHistory();

        // Utility: pretty/compact JSON toggle
        let lastJson = null;
        let showPretty = true;
        function renderResultFromJson(json, statusCode){
            lastJson = json;
            httpStatus.textContent = statusCode ? `HTTP ${statusCode}` : '';
            if(showPretty){
                try{
                    resultElem.textContent = JSON.stringify(json, null, 4);
                }catch(e){
                    resultElem.textContent = String(json);
                }
            } else {
                try{
                    resultElem.textContent = JSON.stringify(json);
                }catch(e){
                    resultElem.textContent = String(json);
                }
            }
        }

        // Copy / Download
        btnCopy.addEventListener('click', () => {
            if(!resultElem.textContent) return;
            navigator.clipboard.writeText(resultElem.textContent)
            .then(()=> {
                statusEl.textContent = 'Copied';
                setTimeout(()=> statusEl.textContent = 'Ready', 1200);
            })
            .catch(()=> showError('ไม่สามารถคัดลอกได้'));
        });

        btnCopyUrl.addEventListener('click', () => {
            const url = buildProxyUrlFromInput();
            if(!url) return showError('ไม่มี URL ที่จะคัดลอก');
            navigator.clipboard.writeText(url)
                .then(()=> {
                    statusEl.textContent = 'URL copied';
                    setTimeout(()=> statusEl.textContent = 'Ready', 1200);
                })
                .catch(()=> showError('คัดลอก URL ไม่สำเร็จ'));
        });

        btnDownload.addEventListener('click', () => {
            if(!resultElem.textContent) return showError('ไม่มีข้อมูลให้ดาวน์โหลด');
            const blob = new Blob([resultElem.textContent], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'response.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(()=> URL.revokeObjectURL(a.href), 1500);
        });

        btnPretty.addEventListener('click', () => {
            showPretty = true;
            if(lastJson !== null) renderResultFromJson(lastJson);
            btnPretty.classList.add('btn-primary');
            btnPretty.style.color='white';
            btnToggleRaw.classList.remove('btn-primary');
            btnToggleRaw.style.color='';
        });

        btnToggleRaw.addEventListener('click', () => {
            showPretty = false;
            if(lastJson !== null) renderResultFromJson(lastJson);
            btnToggleRaw.classList.add('btn-primary');
            btnToggleRaw.style.color='white';
            btnPretty.classList.remove('btn-primary');
            btnPretty.style.color='';
        });

        // Toggle proxy usage
        btnToggleProxy.addEventListener('click', () => {
            useProxy = !useProxy;
            proxyTag.innerHTML = `Using proxy: <strong style="margin-left:6px">${useProxy ? 'cors-anywhere.herokuapp.com' : 'disabled'}</strong>`;
        });

        // Save preset
        btnSavePreset.addEventListener('click', () => {
            const val = inputUrl.value.trim();
            if(!val){ showError('ไม่มี URL ให้บันทึกเป็น preset'); return; }
            const label = prompt('ตั้งชื่อ preset (ปล่อยว่างเพื่อใช้ URL เป็นชื่อ):');
            addPreset(label || val, val);
            statusEl.textContent = 'Preset saved';
            setTimeout(()=> statusEl.textContent = 'Ready', 1000);
        });

        // Clear form
        btnClear.addEventListener('click', () => {
            inputUrl.value = '';
            clearError();
            resultElem.textContent = '';
            inputUrl.focus();
        });

        // History controls
        btnClearHistory.addEventListener('click', () => {
            if(confirm('ลบประวัติทั้งหมด?')) {
                clearHistory();
                statusEl.textContent = 'History cleared';
                setTimeout(()=> statusEl.textContent = 'Ready', 1000);
            }
        });
        btnResetPresets.addEventListener('click', () => {
            if(confirm('คืนค่า presets เริ่มต้น?')) {
                resetPresets();
                statusEl.textContent = 'Presets reset';
                setTimeout(()=> statusEl.textContent = 'Ready', 1000);
            }
        });

        // Build and return the proxied URL string or plain URL depending on useProxy
        function buildProxyUrlFromInput(){
            const fullUrlStr = inputUrl.value.trim();
            if(!fullUrlStr) return null;
            try{
                let urlObj = new URL(fullUrlStr);
                urlObj = fixApiPath(urlObj);
                // remove type & output like original
                urlObj.searchParams.delete('type');
                urlObj.searchParams.delete('output');

                // fill action if not present and select provided
                if(actionSelect.value) urlObj.searchParams.set('action', actionSelect.value);
                else if(!urlObj.searchParams.get('action')) urlObj.searchParams.set('action', 'get_info');

                const final = urlObj.toString();
                return useProxy ? (PROXY_BASE + final) : final;
            }catch(e){
                return null;
            }
        }

        // Main request handler (preserves previous behavior and header)
        form.addEventListener('submit', event => {
            event.preventDefault();
            clearError();

            const fullUrl = inputUrl.value.trim();
            if (!fullUrl) {
                showError('กรุณากรอก URL');
                return;
            }

            let urlObj;
            try {
                urlObj = new URL(fullUrl);
            } catch (err) {
                showError('URL ไม่ถูกต้อง');
                return;
            }

            // Adjust path and params like original
            urlObj = fixApiPath(urlObj);
            urlObj.searchParams.delete('type');
            urlObj.searchParams.delete('output');

            const username = urlObj.searchParams.get('username');
            const password = urlObj.searchParams.get('password');
            if (!username || !password) {
                showError('กรุณาใส่ username และ password ใน URL');
                return;
            }

            if (!urlObj.searchParams.get('action')) {
                if(actionSelect.value) urlObj.searchParams.set('action', actionSelect.value);
                else urlObj.searchParams.set('action', 'get_info');
            }

            // Construct final URL and perform fetch
            const targetUrl = urlObj.toString();
            const proxyUrl = useProxy ? (PROXY_BASE + targetUrl) : targetUrl;

            // Update UI
            resultElem.textContent = 'Loading...';
            setLoading(true);
            httpStatus.textContent = '';
            updateLastInfo(`Requesting: ${useProxy ? 'via proxy' : 'direct'} — ${new Date().toLocaleString()}`);
            
            // Save to history — store the original input URL (fullUrl) instead of targetUrl
            saveHistoryItem(fullUrl);

            fetch(proxyUrl, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                setLoading(false);
                if(!response.ok) {
                    httpStatus.textContent = `HTTP ${response.status}`;
                    throw new Error(`Network response was not ok: ${response.status}`);
                }
                // Try parse JSON, but if fails, return text
                const contentType = response.headers.get('content-type') || '';
                if(contentType.includes('application/json')) {
                    return response.json().then(jsonData => ({ jsonData, status: response.status }));
                } else {
                    return response.text().then(txt => ({ txt, status: response.status }));
                }
            })
            .then(obj => {
                if(obj.jsonData){
                    const jsonData = obj.jsonData;
                    // convert timestamps like original
                    if(jsonData.user_info){
                        jsonData.user_info.exp_date_readable = convertTimestamp(jsonData.user_info.exp_date);
                        jsonData.user_info.created_at_readable = convertTimestamp(jsonData.user_info.created_at);
                    }
                    if(jsonData.server_info){
                        jsonData.server_info.timestamp_now_readable = convertTimestamp(jsonData.server_info.timestamp_now);
                    }
                    renderResultFromJson(jsonData, obj.status);
                    clearError();
                } else if(obj.txt){
                    // display raw text
                    lastJson = null;
                    httpStatus.textContent = `HTTP ${obj.status}`;
                    resultElem.textContent = obj.txt;
                }
            })
            .catch(err => {
                setLoading(false);
                showError('เกิดข้อผิดพลาด: ' + err.message);
                resultElem.textContent = '';
            });
        });

        // Initial UI states
        btnPretty.classList.add('btn-primary');
        btnPretty.style.color='white';

        // Expose a keyboard shortcut: Ctrl+Enter to submit
        inputUrl.addEventListener('keydown', (e) => {
            if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
                btnFetch.click();
            }
        });

        // Render initial tags
        proxyTag.innerHTML = `Using proxy: <strong style="margin-left:6px">${useProxy ? 'cors-anywhere.herokuapp.com' : 'disabled'}</strong>`;
        rateTag.innerHTML = 'Rate limit: 20 req/min';

        // set initial last info
        updateLastInfo('Ready — no requests yet');

    </script>
</body>
</html>
